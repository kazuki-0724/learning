<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ†ã‚¹ãƒˆè¨¼è·¡Markdownç”Ÿæˆãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        body { font-family: "Inter", sans-serif; background-color: #f3f4f6; }
        .editor-container {
            max-width: 800px;
            margin: 0 auto;
        }
        #drawingCanvas {
            border: 2px solid #3b82f6;
            cursor: crosshair;
            background-color: #ffffff;
            touch-action: none; /* ãƒ¢ãƒã‚¤ãƒ«ã§ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ */
        }
        /* æç”»ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .mode-button {
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .mode-button.active {
            border: 2px solid #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
            background-color: #eef2ff;
        }
        
        /* Markdownãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        .markdown-preview h1, .markdown-preview h2 { font-size: 1.5rem; font-weight: 700; margin-top: 1.5rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; }
        .markdown-preview h3 { font-size: 1.25rem; font-weight: 600; margin-top: 1rem; }
        .markdown-preview table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .markdown-preview th, .markdown-preview td { border: 1px solid #d1d5db; padding: 8px; text-align: left; }
        .markdown-preview th { background-color: #f3f4f6; }
        .markdown-preview img { max-width: 100%; height: auto; display: block; margin: 1rem auto; border: 1px solid #ccc; border-radius: 4px; }
        .markdown-preview ul { list-style-type: disc; margin-left: 1.5rem; padding-left: 0; }
        .markdown-preview li { margin-bottom: 0.25rem; }

        /* ãƒãƒ«ãƒã‚»ãƒ¬ã‚¯ãƒˆã®è¦‹ãŸç›®èª¿æ•´ */
        .multi-select-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
        }
        .multi-select-item {
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
            padding-right: 40px; /* ã‚¢ã‚¤ã‚³ãƒ³åˆ†ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ */
        }
        .multi-select-item:hover {
            background-color: #f3f4f6;
        }
        .multi-select-item.selected {
            background-color: #bfdbfe; /* blue-200 */
            font-weight: 600;
        }
        .multi-select-item.focused {
            border: 2px solid #ef4444; /* red-500 */
            background-color: #fee2e2; /* red-100 */
        }
        .multi-select-item.has-image::after {
            content: 'ğŸ“¸'; /* ã‚«ãƒ¡ãƒ©çµµæ–‡å­— */
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.1rem;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#10b981',
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 sm:p-8">

    <div class="editor-container bg-white shadow-xl rounded-xl p-6 space-y-8">
        <h1 class="text-3xl font-extrabold text-gray-800 text-center border-b pb-4 mb-4">
            ãƒ†ã‚¹ãƒˆè¨¼è·¡Markdownç”Ÿæˆ (ã‚±ãƒ¼ã‚¹åˆ¥ç”»åƒç®¡ç†)
        </h1>

        <section class="space-y-4 p-4 border rounded-lg bg-blue-50">
            <h2 class="text-xl font-semibold text-primary">ã‚¹ãƒ†ãƒƒãƒ— 1: ãƒ†ã‚¹ãƒˆä»•æ§˜ã®ç™»éŒ²ã¨é¸æŠ</h2>
            
            <div class="p-3 border rounded-lg bg-white shadow-sm space-y-3">
                <h3 class="text-lg font-bold text-gray-700">A. ãƒ†ã‚¹ãƒˆä»•æ§˜æ›¸ (CSV) ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
                <label for="specImport" class="block text-sm font-medium text-gray-700">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</label>
                <input type="file" id="specImport" accept=".csv"
                       class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 cursor-pointer">
                <p id="specStatus" class="text-sm text-gray-500">â€» å½¢å¼: è¦ªç•ª,æç•ª,"æ¡ä»¶1|æ¡ä»¶2","æœŸå¾…1|æœŸå¾…2"</p>
            </div>

            <div class="p-3 border rounded-lg bg-white shadow-sm space-y-3">
                <h3 class="text-lg font-bold text-gray-700">B. ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’æ‰‹å‹•ã§è¿½åŠ </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label for="manualParentId" class="block text-sm font-medium text-gray-700">è¦ªç•ª</label>
                        <input type="text" id="manualParentId" placeholder="ä¾‹: TC-002" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                    </div>
                    <div>
                        <label for="manualChildId" class="block text-sm font-medium text-gray-700">æç•ª</label>
                        <input type="text" id="manualChildId" placeholder="ä¾‹: 03" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                    </div>
                </div>
                
                <div>
                    <label for="manualConditions" class="block text-sm font-medium text-gray-700">ãƒ†ã‚¹ãƒˆæ¡ä»¶ (æ”¹è¡Œã¾ãŸã¯ "|" åŒºåˆ‡ã‚Š)</label>
                    <textarea id="manualConditions" rows="3" placeholder="ä¾‹: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ç®¡ç†è€…æ¨©é™ã‚’æŒã¤&#10;å•†å“Aã¯åœ¨åº«åˆ‡ã‚Œ" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border"></textarea>
                </div>
                
                <div>
                    <label for="manualExpectations" class="block text-sm font-medium text-gray-700">æƒ³å®šã•ã‚Œã‚‹çµæœ (æ”¹è¡Œã¾ãŸã¯ "|" åŒºåˆ‡ã‚Š)</label>
                    <textarea id="manualExpectations" rows="3" placeholder="ä¾‹: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹&#10;å‡¦ç†ãŒä¸­æ–­ã•ã‚Œã‚‹" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border"></textarea>
                </div>

                <button id="addManualTestCase" class="w-full px-4 py-2 bg-indigo-500 text-white rounded-lg text-sm font-medium hover:bg-indigo-600 transition shadow-md">
                    ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ 
                </button>
            </div>

            <div class="h-px bg-gray-200 my-4"></div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">C. ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®é¸æŠ (è¤‡æ•°é¸æŠå¯)</label>
                    <p class="text-xs text-red-500 mb-1 font-bold">âš ï¸ èµ¤æ : ç”»åƒç·¨é›†ä¸­ã®ã‚±ãƒ¼ã‚¹ (åˆ‡ã‚Šæ›¿ãˆæ™‚ã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™)</p>
                    <div id="testCaseList" class="multi-select-list mt-1 bg-white">
                        <p class="p-3 text-gray-500">ä»•æ§˜æ›¸/æ‰‹å‹•ã§ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>
                    </div>
                </div>
                <div>
                    <label for="imageUpload" class="block text-sm font-medium text-gray-700 mb-2">è¨¼è·¡ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</label>
                    <input type="file" id="imageUpload" accept="image/*"
                           class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 cursor-pointer">
                    <p class="text-sm text-gray-500 mt-2">â€» é¸æŠä¸­ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ç”»åƒã¨ã—ã¦ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚</p>
                </div>
            </div>

            <div id="testCaseDetails" class="p-3 bg-white rounded-lg border border-gray-200 mt-4 hidden">
                <h3 class="text-lg font-bold text-gray-700 mb-2">
                    <span id="focusIndicator" class="inline-block px-3 py-1 bg-red-500 text-white rounded-full text-xs mr-2">ç·¨é›†ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ä¸­</span>
                    é¸æŠä¸­ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹è©³ç´°: <span id="selectedId" class="text-primary font-mono"></span>
                </h3>
                <p class="text-sm text-gray-500 italic mb-2">â€» ã“ã®ã‚±ãƒ¼ã‚¹ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒãŒCanvasã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <p class="font-medium text-gray-600">ãƒ†ã‚¹ãƒˆæ¡ä»¶ (Conditions):</p>
                        <ul id="conditionList" class="list-disc ml-5 mt-1 text-gray-800"></ul>
                    </div>
                    <div>
                        <p class="font-medium text-gray-600">æƒ³å®šã•ã‚Œã‚‹çµæœ (Expected):</p>
                        <ul id="expectationList" class="list-disc ml-5 mt-1 text-gray-800"></ul>
                    </div>
                </div>
            </div>

        </section>

        <section class="space-y-4 p-4 border rounded-lg shadow-inner" id="canvasSection" style="display:none;">
            <h2 class="text-xl font-semibold text-primary">ã‚¹ãƒ†ãƒƒãƒ— 2: ç”»åƒã®ãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ— (ã‚±ãƒ¼ã‚¹: <span id="currentFocusId" class="font-mono text-red-500">æœªé¸æŠ</span>)</h2>

            <div class="flex flex-wrap gap-4 p-3 bg-gray-100 rounded-lg">
                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium text-gray-700">ãƒ¢ãƒ¼ãƒ‰:</label>
                    <div class="inline-flex space-x-2 rounded-lg bg-white p-1 shadow-sm">
                        <button id="mode-freehand" data-mode="freehand" class="mode-button active px-3 py-1 rounded-lg text-sm font-medium" title="ãƒ•ãƒªãƒ¼ãƒãƒ³ãƒ‰æç”»">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                        </button>
                        <button id="mode-straight" data-mode="straight" class="mode-button px-3 py-1 rounded-lg text-sm font-medium" title="ç›´ç·šæç”»">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                        </button>
                        <button id="mode-rect" data-mode="rect" class="mode-button px-3 py-1 rounded-lg text-sm font-medium" title="é•·æ–¹å½¢æç”»">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6z"></path></svg>
                        </button>
                    </div>
                </div>

                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium text-gray-700">è‰²:</label>
                    <input type="color" id="colorPicker" value="#ff0000" class="w-8 h-8 rounded-full border-none cursor-pointer">
                </div>
                <div class="flex items-center space-x-2">
                    <label for="lineWidth" class="text-sm font-medium text-gray-700">å¤ªã•:</label>
                    <input type="range" id="lineWidth" min="1" max="20" value="5" class="w-20 cursor-pointer">
                    <span id="lineWidthValue" class="text-sm text-gray-600">5</span>
                </div>
                <button id="clearCanvas" class="flex items-center px-4 py-2 bg-red-500 text-white rounded-full text-sm font-medium hover:bg-red-600 transition shadow-md">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    ãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—ã‚’ã‚¯ãƒªã‚¢
                </button>
            </div>

            <div class="flex justify-center items-center overflow-auto">
                <canvas id="drawingCanvas" class="w-full"></canvas>
            </div>
            <p id="canvasMessage" class="text-center text-sm text-red-500 font-medium hidden">â€» ç”»åƒãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
        </section>


        <section class="space-y-4 p-4 border rounded-lg bg-green-50">
            <h2 class="text-xl font-semibold text-secondary">ã‚¹ãƒ†ãƒƒãƒ— 3: Markdownå‡ºåŠ› & ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="generateMarkdown" class="w-full px-5 py-3 bg-secondary text-white rounded-xl text-lg font-bold hover:bg-emerald-600 transition shadow-lg">
                    å…¨ä»¶ã®Markdownã‚’ç”Ÿæˆ & ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (ç”»åƒã‚’ä¿å­˜)
                </button>
                 <button id="downloadMarkdown" class="w-full px-5 py-3 bg-blue-600 text-white rounded-xl text-lg font-bold hover:bg-blue-700 transition shadow-lg disabled:bg-gray-400" disabled>
                    Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </button>
            </div>
            <p class="text-sm text-gray-700">
                **ğŸ’¡ æ³¨è¨˜**: ã€Œç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€**ç¾åœ¨ç·¨é›†ä¸­ã®ã‚±ãƒ¼ã‚¹ã®ç”»åƒãŒç¢ºå®šãƒ»ä¿å­˜**ã•ã‚Œã€ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹**ã™ã¹ã¦ã®ã‚±ãƒ¼ã‚¹**ã®å€‹åˆ¥ç”»åƒã§ãƒ¬ãƒãƒ¼ãƒˆãŒä½œæˆã•ã‚Œã¾ã™ã€‚
            </p>

            <div>
                <label for="markdownOutput" class="block text-sm font-medium text-gray-700 mb-2">ç”Ÿæˆã•ã‚ŒãŸMarkdownã‚³ãƒ¼ãƒ‰</label>
                <textarea id="markdownOutput" rows="10" readonly placeholder="ç”Ÿæˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ã“ã“ã«MarkdownãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚"
                          class="mt-1 block w-full rounded-lg border-gray-300 shadow-inner p-3 font-mono text-sm bg-white"></textarea>
                <button id="copyMarkdown" class="mt-2 px-4 py-2 bg-gray-700 text-white rounded-full text-sm hover:bg-gray-800 transition" style="display:none;">
                    ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
                </button>
            </div>
            
            <div id="markdownPreviewArea" class="mt-8">
                <h3 class="text-xl font-semibold text-primary mb-3">Markdownãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                <div id="previewOutput" class="p-4 border border-gray-300 rounded-lg bg-white min-h-[100px] shadow-inner text-gray-800 markdown-preview">
                    <p class="text-gray-500 italic">ç”Ÿæˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€Markdownã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°çµæœï¼ˆç”»åƒã‚’å«ã‚€ï¼‰ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                </div>
            </div
        </section>

        <div id="messageModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden" onclick="document.getElementById('messageModal').classList.add('hidden')">
            <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full mx-4" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold mb-3 text-gray-800">é€šçŸ¥</h3>
                <p id="modalMessage" class="text-gray-600 mb-4"></p>
                <button onclick="document.getElementById('messageModal').classList.add('hidden')" class="w-full py-2 bg-primary text-white rounded-lg hover:bg-blue-600 transition">é–‰ã˜ã‚‹</button>
            </div>
        </div>

    </div>

    <script type="text/javascript">
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®å®šç¾©
        const $ = id => document.getElementById(id);

        const canvas = $('drawingCanvas');
        const ctx = canvas.getContext('2d');
        const imageUpload = $('imageUpload');
        const generateButton = $('generateMarkdown');
        const downloadButton = $('downloadMarkdown');
        const copyButton = $('copyMarkdown');
        const clearButton = $('clearCanvas');
        const colorPicker = $('colorPicker');
        const lineWidthInput = $('lineWidth');
        const lineWidthValue = $('lineWidthValue');
        const markdownOutput = $('markdownOutput');
        const previewOutput = $('previewOutput');
        const canvasSection = $('canvasSection');
        const modeButtons = document.querySelectorAll('.mode-button');

        const specImport = $('specImport');
        const testCaseList = $('testCaseList');
        const detailContainer = $('testCaseDetails');
        const conditionList = $('conditionList');
        const expectationList = $('expectationList');
        const selectedId = $('selectedId');
        const specStatus = $('specStatus');
        const currentFocusId = $('currentFocusId');

        // æ‰‹å‹•å…¥åŠ›è¦ç´ 
        const addTestCaseButton = $('addManualTestCase'); 

        let testSpecs = []; // å„è¦ç´ ã« evidenceImage, drawings, originalImageSrc ã‚’ä¿æŒ
        let selectedIndices = new Set(); 
        let focusedIndex = -1; // ç¾åœ¨ç·¨é›†ä¸­ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

        let originalImage = null; // Canvasã®èƒŒæ™¯ã¨ãªã‚‹ç”»åƒ (Imageã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ)
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let drawings = []; // ç¾åœ¨Canvasã«æç”»ã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—ã®é…åˆ—
        let drawingMode = 'freehand';
        let currentDrawing = null;


        // ----------------------------------------------------
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        // ----------------------------------------------------

        /**
         * ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ€ãƒ« (alert/confirmã®ä»£æ›¿)
         * @param {string} message - è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
         * @param {boolean} isQuiet - ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤ºã›ãšã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã®ã¿ãƒ­ã‚°ã‚’å‡ºã™ (è‡ªå‹•ä¿å­˜ç”¨)
         */
        function showMessage(message, isQuiet = false) {
            if (isQuiet) {
                console.log(message);
                return;
            }
            $('modalMessage').textContent = message;
            $('messageModal').classList.remove('hidden');
        }
        
        // ----------------------------------------------------
        // æç”»ãƒ­ã‚¸ãƒƒã‚¯ (å¤‰æ›´ãªã—)
        // ----------------------------------------------------
        function redrawAll() {
            if (!originalImage) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                canvasSection.style.display = 'none';
                $('canvasMessage').classList.remove('hidden');
                return;
            }

            // Canvasã‚µã‚¤ã‚ºã‚’ã‚³ãƒ³ãƒ†ãƒŠå¹…ã¨ç”»åƒæ¯”ç‡ã«åˆã‚ã›ã¦è¨­å®š
            const containerWidth = canvasSection.clientWidth - 32; 
            canvas.width = containerWidth;
            const aspectRatio = originalImage.width / originalImage.height;
            const canvasHeight = containerWidth / aspectRatio;
            canvas.height = canvasHeight;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);

            drawings.forEach(d => {
                ctx.strokeStyle = d.color;
                ctx.lineJoin = 'round';
                ctx.lineCap = 'round';
                ctx.lineWidth = d.width;
                
                if (d.type === 'freehand') {
                    ctx.beginPath();
                    if (d.points.length > 0) {
                        ctx.moveTo(d.points[0].x, d.points[0].y);
                        for (let i = 1; i < d.points.length; i++) {
                            ctx.lineTo(d.points[i].x, d.points[i].y);
                        }
                    }
                    ctx.stroke();
                } else if (d.type === 'rect') {
                    const width = d.endX - d.startX;
                    const height = d.endY - d.startY;
                    ctx.strokeRect(d.startX, d.startY, width, height);
                } else if (d.type === 'straight') {
                    ctx.beginPath();
                    ctx.moveTo(d.startX, d.startY);
                    ctx.lineTo(d.endX, d.endY);
                    ctx.stroke();
                }
            });

            ctx.strokeStyle = colorPicker.value;
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            ctx.lineWidth = parseInt(lineWidthInput.value);

            // CanvasãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã«ã™ã‚‹
            canvasSection.style.display = 'block';
            $('canvasMessage').classList.add('hidden');
        }

        function getCanvasCoordinates(clientX, clientY) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        function startDrawing(clientX, clientY) {
            if (focusedIndex === -1 || !originalImage) { 
                showMessage("å…ˆã«ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’é¸æŠã—ã€ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚"); 
                return; 
            }
            isDrawing = true;
            const { x, y } = getCanvasCoordinates(clientX, clientY);
            [lastX, lastY] = [x, y];
            
            const color = colorPicker.value;
            const width = parseInt(lineWidthInput.value);

            if (drawingMode === 'freehand') {
                currentDrawing = { type: 'freehand', points: [{x, y}], color, width };
            } else if (drawingMode === 'rect' || drawingMode === 'straight') {
                currentDrawing = { type: drawingMode, startX: x, startY: y, endX: x, endY: y, color, width };
            }
        }

        function draw(clientX, clientY) {
            if (!isDrawing || !originalImage || !currentDrawing) return;

            const { x, y } = getCanvasCoordinates(clientX, clientY);

            if (drawingMode === 'freehand') {
                currentDrawing.points.push({x, y});
                
                ctx.strokeStyle = currentDrawing.color;
                ctx.lineWidth = currentDrawing.width;
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();

                [lastX, lastY] = [x, y];
                
            } else if (drawingMode === 'rect' || drawingMode === 'straight') {
                redrawAll(); 

                currentDrawing.endX = x;
                currentDrawing.endY = y;

                ctx.strokeStyle = currentDrawing.color;
                ctx.lineWidth = currentDrawing.width;

                if (drawingMode === 'rect') {
                    const width = currentDrawing.endX - currentDrawing.startX;
                    const height = currentDrawing.endY - currentDrawing.startY;
                    ctx.strokeRect(currentDrawing.startX, currentDrawing.startY, width, height);
                } else if (drawingMode === 'straight') {
                    ctx.beginPath();
                    ctx.moveTo(currentDrawing.startX, currentDrawing.startY);
                    ctx.lineTo(currentDrawing.endX, currentDrawing.endY);
                    ctx.stroke();
                }
            }
        }

        function stopDrawing() {
            if (isDrawing && currentDrawing) {
                // æç”»ãƒ‡ãƒ¼ã‚¿ã‚’drawingsé…åˆ—ã«è¿½åŠ 
                if (drawingMode === 'freehand' && currentDrawing.points.length > 1) {
                    drawings.push(currentDrawing);
                } else if ((drawingMode === 'rect' || drawingMode === 'straight') && (currentDrawing.startX !== currentDrawing.endX || currentDrawing.startY !== currentDrawing.endY)) {
                    drawings.push(currentDrawing);
                    redrawAll(); 
                } else {
                    if (drawingMode === 'rect' || drawingMode === 'straight') {
                        redrawAll();
                    }
                }
                
                // æç”»ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚ŒãŸã®ã§ã€æ¬¡ã®ä¿å­˜æ™‚ã«evidenceImageãŒå†ç”Ÿæˆã•ã‚Œã‚‹
                if (focusedIndex !== -1 && testSpecs[focusedIndex]) {
                    testSpecs[focusedIndex].evidenceImage = null;
                }
            }

            isDrawing = false;
            currentDrawing = null;
            [lastX, lastY] = [0, 0];
        }

        // ----------------------------------------------------
        // ã‚¹ãƒ†ãƒ¼ãƒˆç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯
        // ----------------------------------------------------

        /**
         * ç¾åœ¨ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã•ã‚Œã¦ã„ã‚‹ã‚±ãƒ¼ã‚¹ã®Canvasã®çŠ¶æ…‹ã‚’ãƒ‡ãƒ¼ã‚¿ã«ä¿å­˜ã™ã‚‹ (è‡ªå‹•ä¿å­˜)
         */
        function saveCurrentCanvasState() {
            if (focusedIndex === -1 || !testSpecs[focusedIndex] || !originalImage) return;

            // æç”»å±¥æ­´ã‚’ä¿å­˜
            testSpecs[focusedIndex].drawings = JSON.parse(JSON.stringify(drawings)); 

            // evidenceImageãŒnullã®å ´åˆã¯ã€æ¬¡ã®Markdownç”Ÿæˆæ™‚ã«ãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—æ¸ˆã¿ç”»åƒã‚’ç”Ÿæˆã™ã‚‹
            if (testSpecs[focusedIndex].evidenceImage === null) {
                // ã“ã“ã§ã¯Base64ã®å†ç”Ÿæˆã¯è¡Œã‚ãšã€æç”»å±¥æ­´ã®ä¿å­˜ã«ç•™ã‚ã‚‹
                showMessage(`ã‚±ãƒ¼ã‚¹ ${testSpecs[focusedIndex].parentId}-${testSpecs[focusedIndex].childId} ã®æç”»å±¥æ­´ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚`, true); 
            } else {
                showMessage(`ã‚±ãƒ¼ã‚¹ ${testSpecs[focusedIndex].parentId}-${testSpecs[focusedIndex].childId} ã®çŠ¶æ…‹ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚`, true); 
            }
        }

        /**
         * æŒ‡å®šã•ã‚ŒãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã‚±ãƒ¼ã‚¹ã®çŠ¶æ…‹ã‚’Canvasã«ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
         * @param {number} index - ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
         */
        function loadCanvasState(index) {
            const spec = testSpecs[index];
            if (!spec) return;

            // UIã‚’æ›´æ–°
            updateFocusIndicator(index);
            currentFocusId.textContent = `${spec.parentId}-${spec.childId}`;
            
            // ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ç”»åƒã‚½ãƒ¼ã‚¹ã‚’æ±ºå®š (evidenceImage > originalImageSrc ã®é †ã«å„ªå…ˆ)
            const imageSrcToLoad = spec.evidenceImage || spec.originalImageSrc;

            if (imageSrcToLoad) {
                const img = new Image();
                img.onload = () => {
                    originalImage = img;
                    drawings = spec.drawings || [];
                    redrawAll(); // ç”»åƒã‚’èƒŒæ™¯ã«æç”»ã—ã€æç”»å±¥æ­´ã‚’å¾©å…ƒ
                };
                img.src = imageSrcToLoad;
            } else {
                // ç”»åƒãŒå…¨ããªã„å ´åˆã€Canvasã‚’ã‚¯ãƒªã‚¢ã—ã¦éè¡¨ç¤º
                originalImage = null;
                drawings = [];
                redrawAll(); 
            }
        }

        /**
         * ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãƒªã‚¹ãƒˆã®UIã¨è©³ç´°ã‚¨ãƒªã‚¢ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹
         * @param {number} focusedIndex - ç¾åœ¨ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã•ã‚Œã¦ã„ã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
         */
        function updateFocusIndicator(focusedIndex) {
            document.querySelectorAll('.multi-select-item').forEach((item, index) => {
                item.classList.remove('focused');
                if (index === focusedIndex) {
                    item.classList.add('focused');
                }
            });
        }


        // ----------------------------------------------------
        // ãƒ‡ãƒ¼ã‚¿æ“ä½œãƒ­ã‚¸ãƒƒã‚¯
        // ----------------------------------------------------

        /**
         * CSVãƒ†ã‚­ã‚¹ãƒˆã‚’è§£æã—ã¦ãƒ‡ãƒ¼ã‚¿é…åˆ—ã«å¤‰æ›ã™ã‚‹
         */
        function parseCSV(csv) {
            const lines = csv.split('\n').filter(line => line.trim() !== '');
            // ... (ãƒ˜ãƒƒãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯ãªã©ã€æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã¯ç¶­æŒ) ...
            
            // ç°¡æ˜“ãƒ˜ãƒƒãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯ (ä»Šå›ã¯çœç•¥ã—ã€å¿…ãšãƒ‡ãƒ¼ã‚¿ãŒè¿”ã‚‹ã¨ä»®å®š)
            if (lines.length < 1) return [];

            // ç°¡æ˜“çš„ã«ã‚³ãƒ³ãƒåŒºåˆ‡ã‚Šã§ãƒ‘ãƒ¼ã‚¹ï¼ˆä»Šå›ã¯ç°¡æ˜“çš„ã«å®Ÿè£…ï¼‰
            const data = [];
            const header = (lines.shift() || '').split(',').map(h => h.trim());
            
            const pIdIdx = header.indexOf('è¦ªç•ª');
            const cIdIdx = header.indexOf('æç•ª');
            const condIdx = header.indexOf('ãƒ†ã‚¹ãƒˆæ¡ä»¶');
            const expIdx = header.indexOf('æƒ³å®šã•ã‚Œã‚‹çµæœ');

            if (pIdIdx === -1 || cIdIdx === -1 || condIdx === -1 || expIdx === -1) {
                 throw new Error("CSVãƒ˜ãƒƒãƒ€ãƒ¼ã«'è¦ªç•ª', 'æç•ª', 'ãƒ†ã‚¹ãƒˆæ¡ä»¶', 'æƒ³å®šã•ã‚Œã‚‹çµæœ'ã®ã„ãšã‚Œã‹ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚");
            }

            lines.forEach(line => {
                // CSVãƒ‘ãƒ¼ã‚µãƒ¼ã‚’ä½¿ã‚ãšã€ç°¡æ˜“çš„ã«split(',')ã‚’ä½¿ç”¨ (å¼•ç”¨ç¬¦å¯¾å¿œã¯å›°é›£ãªãŸã‚ã€ãƒ¦ãƒ¼ã‚¶ã«å½¢å¼ã‚’æ±‚ã‚ã‚‹)
                const values = line.match(/(".*?"|[^",\r\n]+)(?=\s*,|\s*$)/g) || [];
                
                const conditions = (values[condIdx] || '').replace(/"/g, '').split('|').map(c => c.trim()).filter(c => c);
                const expectations = (values[expIdx] || '').replace(/"/g, '').split('|').map(e => e.trim()).filter(e => e);

                data.push({
                    parentId: (values[pIdIdx] || '').trim(),
                    childId: (values[cIdIdx] || '').trim(),
                    conditions: conditions,
                    expectations: expectations,
                    source: 'csv',
                    evidenceImage: null, // å€‹åˆ¥ç”»åƒç”¨
                    drawings: [], // å€‹åˆ¥æç”»å±¥æ­´ç”¨
                    originalImageSrc: null // åˆæœŸç”»åƒç”¨
                });
            });
            return data.filter(d => d.parentId && d.childId); // å¿…é ˆé …ç›®ãŒãªã„ã‚‚ã®ã‚’é™¤å¤–
        }

        /**
         * è¤‡æ•°è¡Œã¾ãŸã¯ãƒ‘ã‚¤ãƒ—åŒºåˆ‡ã‚Šã®ãƒ†ã‚­ã‚¹ãƒˆã‚’é…åˆ—ã«å¤‰æ›ã™ã‚‹ (æ‰‹å‹•å…¥åŠ›ç”¨)
         */
        function parseFactors(text) {
            if (!text) return [];
            return text.split(/[\n|]/)
                       .map(r => r.trim())
                       .filter(r => r); 
        }

        /**
         * é¸æŠãƒªã‚¹ãƒˆã‚’æ›´æ–°ã™ã‚‹
         */
        function updateTestSelector() {
            testCaseList.innerHTML = '';
            // selectedIndices.clear(); // é¸æŠçŠ¶æ…‹ã¯ç¶­æŒã—ãŸã„å ´åˆã‚‚ã‚ã‚‹ãŸã‚ã‚¯ãƒªã‚¢ã—ãªã„

            if (testSpecs.length === 0) {
                testCaseList.innerHTML = '<p class="p-3 text-gray-500">ä»•æ§˜æ›¸/æ‰‹å‹•ã§ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>';
                displayTestCaseDetails(null);
                focusedIndex = -1;
                return;
            }

            testSpecs.forEach((spec, index) => {
                const item = document.createElement('div');
                item.className = 'multi-select-item border-b last:border-b-0';
                if (selectedIndices.has(index)) {
                    item.classList.add('selected');
                }
                if (spec.evidenceImage || spec.originalImageSrc) {
                    item.classList.add('has-image');
                }
                item.setAttribute('data-index', index);
                item.textContent = `${spec.parentId}-${spec.childId} (${spec.source === 'csv' ? 'CSV' : 'æ‰‹å‹•'})`;
                
                item.addEventListener('click', (e) => handleCaseSelection(e, index, item));
                testCaseList.appendChild(item);
            });

            // æ—¢å­˜ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å†ãƒ­ãƒ¼ãƒ‰
            if (focusedIndex !== -1 && testSpecs[focusedIndex]) {
                loadCanvasState(focusedIndex);
                displayTestCaseDetails(testSpecs[focusedIndex]);
            } else {
                displayTestCaseDetails(null);
                currentFocusId.textContent = 'æœªé¸æŠ';
            }
        }

        /**
         * ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹é¸æŠæ™‚ã®å‡¦ç† (ãƒãƒ«ãƒã‚»ãƒ¬ã‚¯ãƒˆ & ãƒ•ã‚©ãƒ¼ã‚«ã‚¹åˆ‡ã‚Šæ›¿ãˆ)
         */
        function handleCaseSelection(e, index, item) {
            // --- 1. ãƒãƒ«ãƒã‚»ãƒ¬ã‚¯ãƒˆå‡¦ç† ---
            const isSelected = selectedIndices.has(index);

            if (e.shiftKey) {
                // Shiftã‚­ãƒ¼: å…¨ã¦ã‚’é¸æŠ/é¸æŠè§£é™¤ã®ãƒˆã‚°ãƒ« (ä»Šå›ã¯ç°¡ç•¥åŒ–ã—ã€ãƒˆã‚°ãƒ«ã—ãªã„)
                // æœ€å¾Œã«ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚‚ã®ã‹ã‚‰ç¾åœ¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¾ã§ã®ç¯„å›²é¸æŠã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã ãŒã€ã“ã“ã§ã¯å˜ä¸€/å…¨ä½“ãƒˆã‚°ãƒ«ã«ç•™ã‚ã‚‹
                if (selectedIndices.size === testSpecs.length) {
                    selectedIndices.clear();
                    document.querySelectorAll('.multi-select-item').forEach(i => i.classList.remove('selected'));
                } else {
                    selectedIndices.clear();
                    testSpecs.forEach((_, i) => selectedIndices.add(i));
                    document.querySelectorAll('.multi-select-item').forEach(i => i.classList.add('selected'));
                }
            } else {
                // å˜ä¸€é¸æŠ/ãƒˆã‚°ãƒ«
                if (isSelected) {
                    selectedIndices.delete(index);
                    item.classList.remove('selected');
                } else {
                    selectedIndices.add(index);
                    item.classList.add('selected');
                }
            }

            // --- 2. ãƒ•ã‚©ãƒ¼ã‚«ã‚¹åˆ‡ã‚Šæ›¿ãˆå‡¦ç† ---
            // é¸æŠ/éé¸æŠã«ã‹ã‹ã‚ã‚‰ãšã€æœ€å¾Œã«ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚±ãƒ¼ã‚¹ã«ç·¨é›†ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å½“ã¦ã‚‹
            if (focusedIndex !== index) {
                // ç¾åœ¨ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã•ã‚Œã¦ã„ã‚‹ã‚±ãƒ¼ã‚¹ã®çŠ¶æ…‹ã‚’ä¿å­˜
                if (focusedIndex !== -1 && testSpecs[focusedIndex]) {
                    saveCurrentCanvasState();
                }

                // æ–°ã—ã„ã‚±ãƒ¼ã‚¹ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’è¨­å®š
                focusedIndex = index;

                // æ–°ã—ã„ã‚±ãƒ¼ã‚¹ã®çŠ¶æ…‹ã‚’ãƒ­ãƒ¼ãƒ‰
                loadCanvasState(index);
            }
            
            // 3. æœ€å¾Œã«ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚±ãƒ¼ã‚¹ã®è©³ç´°ã‚’è¡¨ç¤º
            displayTestCaseDetails(testSpecs[index]);
        }


        /**
         * ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®è©³ç´°ã‚’è¡¨ç¤ºã‚¨ãƒªã‚¢ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹
         * @param {object | null} spec - é¸æŠã•ã‚ŒãŸãƒ†ã‚¹ãƒˆä»•æ§˜
         */
        function displayTestCaseDetails(spec) {
            conditionList.innerHTML = '';
            expectationList.innerHTML = '';

            if (!spec) {
                detailContainer.classList.add('hidden');
                selectedId.textContent = '';
                return;
            }
            
            detailContainer.classList.remove('hidden');
            selectedId.textContent = `${spec.parentId}-${spec.childId}`;

            spec.conditions.forEach(cond => {
                const li = document.createElement('li');
                li.textContent = cond;
                conditionList.appendChild(li);
            });

            spec.expectations.forEach(exp => {
                const li = document.createElement('li');
                li.textContent = exp;
                expectationList.appendChild(li);
            });
        }

        /**
         * é¸æŠã•ã‚ŒãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®Markdownã‚’ç”Ÿæˆã™ã‚‹å…±é€šãƒ­ã‚¸ãƒƒã‚¯
         * @param {object} spec - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ã‚¿
         * @param {string} dataURL - è¨¼è·¡ç”»åƒBase64 URL
         * @returns {string} - ç”Ÿæˆã•ã‚ŒãŸMarkdownãƒ†ã‚­ã‚¹ãƒˆ
         */
        function generateSingleCaseMarkdown(spec, dataURL) {
            const parentId = spec.parentId;
            const childId = spec.childId;
            const imagePlaceholder = dataURL.startsWith('data:') ? 
                `![è¨¼è·¡ç”»åƒï¼š${parentId}-${childId}](${dataURL})` :
                `**ç”»åƒãªã—** (ã“ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã«ã¯ç”»åƒãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“)`;

            // Markdownãƒªã‚¹ãƒˆå½¢å¼ã«å¤‰æ›
            const conditionsMarkdown = spec.conditions.map(c => `* ${c}`).join('\n');
            const expectationsMarkdown = spec.expectations.map(e => `* ${e}`).join('\n');

            return `## ãƒ†ã‚¹ãƒˆè¨¼è·¡: ${parentId}-${childId}

| é …ç›® | å€¤ |
| :--- | :--- |
| **ãƒ†ã‚¹ãƒˆè¦ªç•ª** | \`${parentId}\` |
| **æç•ª** | \`${childId}\` |
| **ç™»éŒ²å…ƒ** | \`${spec.source === 'csv' ? 'CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ' : 'æ‰‹å‹•å…¥åŠ›'}\` |

---

### å®Ÿè¡Œæ¡ä»¶ (Test Conditions)

${conditionsMarkdown}

### æƒ³å®šçµæœ (Expected Result)

${expectationsMarkdown}

---

### è¨¼è·¡ç”»åƒ

${imagePlaceholder}

---

`;
        }
        
        // ----------------------------------------------------
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        // ----------------------------------------------------

        // CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        specImport.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const csvText = event.target.result;
                    const newSpecs = parseCSV(csvText);
                    testSpecs.push(...newSpecs); 
                    updateTestSelector();
                    specStatus.textContent = `âœ… ${newSpecs.length}ä»¶ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚ç·ä»¶æ•°: ${testSpecs.length}`;
                    specStatus.classList.remove('text-gray-500', 'text-red-500');
                    specStatus.classList.add('text-secondary', 'font-bold');
                } catch (error) {
                    showMessage("CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã¾ãŸã¯è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                    console.error('CSV Parsing Error:', error);
                    specStatus.textContent = "âŒ CSVã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
                    specStatus.classList.remove('text-gray-500', 'font-bold', 'text-secondary');
                    specStatus.classList.add('text-red-500');
                }
            };
            reader.readAsText(file);
        });

        // ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®æ‰‹å‹•è¿½åŠ 
        addTestCaseButton.addEventListener('click', () => {
            const parentId = $('manualParentId').value.trim();
            const childId = $('manualChildId').value.trim();
            const conditionsText = $('manualConditions').value.trim();
            const expectationsText = $('manualExpectations').value.trim();

            if (!parentId || !childId || !conditionsText || !expectationsText) {
                showMessage("è¦ªç•ªã€æç•ªã€ãƒ†ã‚¹ãƒˆæ¡ä»¶ã€æƒ³å®šã•ã‚Œã‚‹çµæœã®ã™ã¹ã¦ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            const conditions = parseFactors(conditionsText);
            const expectations = parseFactors(expectationsText);

            if (conditions.length === 0 || expectations.length === 0) {
                showMessage("ãƒ†ã‚¹ãƒˆæ¡ä»¶ã¨æƒ³å®šã•ã‚Œã‚‹çµæœã‚’æœ€ä½1ã¤ã¯å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            testSpecs.push({
                parentId: parentId,
                childId: childId,
                conditions: conditions,
                expectations: expectations,
                source: 'manual',
                evidenceImage: null,
                drawings: [],
                originalImageSrc: null
            });

            // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            $('manualParentId').value = '';
            $('manualChildId').value = '';
            $('manualConditions').value = '';
            $('manualExpectations').value = '';

            updateTestSelector();
            showMessage(`ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ ${parentId}-${childId} ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸã€‚`);
        });

        // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        imageUpload.addEventListener('change', (e) => {
            if (focusedIndex === -1) {
                showMessage("å…ˆã«ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„ã€‚");
                e.target.value = null; 
                return;
            }
            
            const file = e.target.files[0];
            if (!file) { return; }

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    // è¨¼è·¡ç”»åƒãŒãªã„çŠ¶æ…‹ã®åˆæœŸç”»åƒã¨ã—ã¦specã«ä¿å­˜
                    testSpecs[focusedIndex].originalImageSrc = event.target.result;
                    testSpecs[focusedIndex].evidenceImage = null; // ãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—å‰ã«ãƒªã‚»ãƒƒãƒˆ
                    testSpecs[focusedIndex].drawings = [];
                    
                    // Canvasã‚’ãƒªãƒ­ãƒ¼ãƒ‰
                    originalImage = img;
                    drawings = [];
                    redrawAll();
                    updateTestSelector(); // ç”»åƒãŒã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
                    showMessage(`ç”»åƒã‚’ ${testSpecs[focusedIndex].parentId}-${testSpecs[focusedIndex].childId} ã«ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚`);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // Canvasæç”»ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š (ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œå«ã‚€)
        canvas.addEventListener('mousedown', (e) => startDrawing(e.clientX, e.clientY));
        canvas.addEventListener('mousemove', (e) => draw(e.clientX, e.clientY));
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startDrawing(e.touches[0].clientX, e.touches[0].clientY);
        });
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            draw(e.touches[0].clientX, e.touches[0].clientY);
        });
        canvas.addEventListener('touchend', stopDrawing);

        // Markdownä¸€æ‹¬ç”Ÿæˆ
        generateButton.addEventListener('click', () => {
            // 1. ç¾åœ¨ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ä¸­ã®çŠ¶æ…‹ã‚’æœ€å¾Œã«ä¿å­˜ã—ã€ãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—æ¸ˆã¿ç”»åƒã‚’ç”Ÿæˆ
            if (focusedIndex !== -1 && originalImage) {
                testSpecs[focusedIndex].evidenceImage = canvas.toDataURL('image/png');
                testSpecs[focusedIndex].drawings = JSON.parse(JSON.stringify(drawings)); 
                showMessage(`ã‚±ãƒ¼ã‚¹ ${testSpecs[focusedIndex].parentId}-${testSpecs[focusedIndex].childId} ã®ãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—æ¸ˆã¿ç”»åƒã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚`, true); 
                updateTestSelector(); // ç”»åƒã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
            }
            
            // â˜…å¤‰æ›´ç‚¹: é¸æŠä»¶æ•°ã§ã¯ãªãã€ãƒªã‚¹ãƒˆå…¨ä½“ã®ä»¶æ•°ã§ãƒã‚§ãƒƒã‚¯
            if (testSpecs.length === 0) {
                showMessage("Markdownã‚’ç”Ÿæˆã™ã‚‹ã«ã¯ã€ãƒªã‚¹ãƒˆã«ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãŒ1ä»¶ä»¥ä¸Šå¿…è¦ã§ã™ã€‚");
                return;
            }

            let combinedMarkdown = `# ãƒ†ã‚¹ãƒˆè¨¼è·¡ãƒ¬ãƒãƒ¼ãƒˆ\n\n---`;
            
            // â˜…å¤‰æ›´ç‚¹: é¸æŠã•ã‚ŒãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ã¯ãªãã€ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ãƒ«ãƒ¼ãƒ—
            testSpecs.forEach(spec => {
                if (spec) {
                    const dataURL = spec.evidenceImage || spec.originalImageSrc || 'No Image Data'; 
                    const singleCaseMarkdown = generateSingleCaseMarkdown(spec, dataURL);
                    combinedMarkdown += singleCaseMarkdown;
                }
            });

            // 2. å‡ºåŠ›ã‚¨ãƒªã‚¢ã«è¡¨ç¤º
            markdownOutput.value = combinedMarkdown;
            
            // 3. Markdownã‚’HTMLã«å¤‰æ›ã—ã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã«è¡¨ç¤º
            previewOutput.innerHTML = marked.parse(combinedMarkdown);

            // 4. UIã®çŠ¶æ…‹æ›´æ–°
            copyButton.style.display = 'block';
            downloadButton.disabled = false;
            // â˜…å¤‰æ›´ç‚¹: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¨ä»¶æ•°ãƒ™ãƒ¼ã‚¹ã«å¤‰æ›´
            showMessage(`âœ… å…¨${testSpecs.length}ä»¶ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®Markdownã‚’ä¸€æ‹¬ç”Ÿæˆã—ã¾ã—ãŸï¼`);
        });

        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadFile(filename, text) {
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        downloadButton.addEventListener('click', () => {
            const content = markdownOutput.value;
            
            // â˜…å¤‰æ›´ç‚¹: selectedIndices.size ã‚’ testSpecs.length ã«å¤‰æ›´
            if (content && testSpecs.length > 0) {
                const firstSpec = testSpecs[0];
                const lastSpec = testSpecs[testSpecs.length - 1];
                
                let filename = `evidence_report`;
                // â˜…å¤‰æ›´ç‚¹: testSpecs.length ã§ãƒ•ã‚¡ã‚¤ãƒ«åã‚’åˆ¤å®š
                if (testSpecs.length === 1) {
                    filename = `evidence_${firstSpec.parentId}-${firstSpec.childId}.md`;
                } else if (firstSpec && lastSpec) {
                    filename = `evidence_${firstSpec.parentId}-${firstSpec.childId}_to_${lastSpec.parentId}-${lastSpec.childId}.md`;
                }
                
                if (filename.endsWith('.md') === false) filename += '.md';
                
                downloadFile(filename, content);
                showMessage(`${filename} ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚`);
            } else {
                showMessage("å…ˆã«Markdownã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚");
            }
        });

        // ã‚³ãƒ”ãƒ¼
        copyButton.addEventListener('click', () => {
            const content = markdownOutput.value;
            if (content) {
                // document.execCommand('copy') ã‚’ä½¿ç”¨
                const textarea = markdownOutput;
                textarea.select();
                textarea.setSelectionRange(0, 99999); 
                try {
                    document.execCommand('copy');
                    showMessage("Markdownã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
                } catch (err) {
                    console.error('ã‚³ãƒ”ãƒ¼å¤±æ•—:', err);
                    showMessage("ã‚³ãƒ¼ãƒ‰ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
                }
                window.getSelection().removeAllRanges();
            }
        });

        // ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        modeButtons.forEach(button => {
            button.addEventListener('click', () => {
                const mode = button.getAttribute('data-mode');
                drawingMode = mode;
                modeButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
            });
        });

        lineWidthInput.addEventListener('input', () => {
            lineWidthValue.textContent = lineWidthInput.value;
            ctx.lineWidth = parseInt(lineWidthInput.value);
        });

        clearButton.addEventListener('click', () => {
            if (focusedIndex === -1 || !originalImage) {
                 showMessage("ç”»åƒã‚’ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
                 return;
            }
            if (confirm("ç¾åœ¨ã®ãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                drawings = [];
                // evidenceImage ã‚’ null ã«æˆ»ã™ (å†ç”Ÿæˆã•ã›ã‚‹ãŸã‚)
                testSpecs[focusedIndex].evidenceImage = null; 
                redrawAll();
                showMessage("ãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚");
            }
        });

        // åˆæœŸåŒ–ã¨ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
        window.addEventListener('resize', redrawAll);
        window.onload = () => {
            canvasSection.style.display = 'none';
        };

    </script>
</body>
</html>