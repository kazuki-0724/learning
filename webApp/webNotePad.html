<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D Sticky Notes Board</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kalam:wght@400;700&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #1a1a1a;
            font-family: 'Kalam', cursive, sans-serif;
            cursor: grab;
        }
        
        body:active {
            cursor: grabbing;
        }

        /* ------------------------------------- */
        /* Control UI Layout Adjustment - Modernized */
        /* ------------------------------------- */

        /* å·¦ä¸Š: ä¸»è¦ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (è‰²é¸æŠ, ã‚¯ãƒªã‚¢, ãƒ˜ãƒ«ãƒ—) */
        #primary-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 15px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
            z-index: 100;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        /* å³ä¸Š: æ¤œç´¢æ©Ÿèƒ½ã®ã¿ */
        #search-container {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 5px;
            background: rgba(255, 255, 255, 0.2);
            padding: 6px;
            border-radius: 8px;
            width: 250px;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 100;
        }

        /* å³ä¸‹: ã‚«ãƒ¡ãƒ©æ“ä½œã¨ãƒ‡ãƒ¼ã‚¿ç®¡ç† */
        #utility-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        /* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£å†…ã®ãƒœã‚¿ãƒ³ã®æ¨ªä¸¦ã³ã‚°ãƒ«ãƒ¼ãƒ— */
        .util-group {
            display: flex;
            gap: 8px;
        }


        #search-input {
            padding: 5px 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            flex-grow: 1;
            font-family: sans-serif;
            font-size: 0.9rem;
            outline: none;
        }
        
        #search-input::placeholder {
            color: #ccc;
        }

        .control-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: background-color 0.2s, transform 0.1s;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        #search-btn {
            padding: 5px 10px;
            border-radius: 6px;
            background-color: rgba(50, 200, 255, 0.8);
            color: black;
            font-weight: bold;
            font-size: 0.9rem;
        }

        /* åº§æ¨™ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #reset-position-btn {
            background-color: rgba(0, 150, 255, 0.6);
            padding: 5px 10px;
            border-radius: 10px;
        }
        
        /* ä½¿ã„æ–¹ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #help-btn {
            background-color: rgba(0, 136, 85, 0.6);
        }
        
        /* ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #export-txt-btn {
            background-color: rgba(255, 165, 0, 0.6); 
            padding: 5px 10px;
            border-radius: 10px;
        }
        
        /* å…¨ãƒ¡ãƒ¢å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #clear-data-btn {
            background-color: rgba(170, 0, 0, 0.6);
        }

        .control-btn.zoom-btn {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 50%;
            font-size: 1.5rem;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .control-btn:active {
            transform: translateY(1px);
        }


        .color-btn {
            width: 30px; /* ã‚µã‚¤ã‚ºã‚’å°‘ã—å°ã•ã */
            height: 30px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
        }

        .color-btn:hover {
            transform: scale(1.1);
        }

        .color-btn.active {
            border-color: #fff;
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        /* The actual 3D Note Styling (CSS3DObject content) */
        .note-element {
            width: 400px;
            height: 400px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            padding: 15px;
            box-sizing: border-box;
            font-size: 20px;
            line-height: 1.4;
            cursor: text;
            user-select: none;
            transition: box-shadow 0.2s, border 0.2s;
            display: flex;
            flex-direction: column;
            /* Post-it curl effect */
            border-bottom-right-radius: 60px 5px;
            border: 3px solid transparent;
            position: relative; 
        }

        /* æ¤œç´¢ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚¹ã‚¿ã‚¤ãƒ« (ç™½è‰²ã«å¤‰æ›´) */
        .note-element.highlighted {
            border: 5px solid #ffffff; 
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.8);
            transition: all 0.2s ease-out;
        }


        .note-element:hover {
            box-shadow: 0 15px 30px rgba(0,0,0,0.4);
        }

        .note-textarea {
            width: 100%;
            height: 100%;
            background: transparent;
            border: none;
            resize: none;
            outline: none;
            font-family: 'Kalam', cursive;
            font-size: 1.2rem;
            color: #333;
        }
        
        .note-textarea::placeholder {
            color: rgba(0,0,0,0.3);
        }
        
        /* å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .delete-btn {
            position: absolute;
            top: -10px; 
            right: -10px; 
            width: 30px;
            height: 30px;
            background: #ff3333;
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            font-size: 1.2rem;
            font-weight: bold;
            line-height: 1;
            cursor: pointer;
            opacity: 0; 
            transition: opacity 0.2s, transform 0.1s;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            pointer-events: none; 
        }

        .note-element:hover .delete-btn {
            opacity: 1; 
            transform: scale(1.1);
            pointer-events: auto; 
        }
        
        .delete-btn:active {
            transform: scale(0.9);
        }
        
        /* ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« (alert()ã®ä»£æ›¿) */
        #confirmation-modal, #help-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none; /* åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤º */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #modal-content, #modal-content-help {
            background: #2b2b2b;
            color: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
            font-family: sans-serif;
            text-align: center;
        }
        
        #modal-content-help h3 {
            margin-top: 0;
            font-size: 1.5rem;
            color: #7afcff; /* ãƒ˜ãƒ«ãƒ—ã®è‰² */
        }
        
        #help-list {
            text-align: left;
            margin-bottom: 25px;
        }

        #help-list p {
            font-size: 1.0rem;
            line-height: 1.5;
            color: #ddd;
            margin: 8px 0;
        }


        #modal-content h3 {
            margin-top: 0;
            font-size: 1.5rem;
            color: #ff5555;
        }

        #modal-content p {
            margin-bottom: 25px;
            font-size: 1.1rem;
            line-height: 1.5;
            color: #ddd;
        }

        #modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        #modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        #confirm-delete-btn {
            background-color: #ff5555;
            color: white;
        }

        #confirm-delete-btn:hover {
            background-color: #e04444;
        }

        #cancel-delete-btn {
            background-color: #555;
            color: white;
        }

        #cancel-delete-btn:hover {
            background-color: #666;
        }

    </style>
    <!-- Import Maps for Three.js -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    
    <!-- å…¨ãƒ¡ãƒ¢å‰Šé™¤ ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«UI -->
    <div id="confirmation-modal">
        <div id="modal-content">
            <h3>è­¦å‘Š</h3>
            <p>å…¨ã¦ã®ãƒ¡ãƒ¢ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚</p>
            <div id="modal-buttons">
                <button id="confirm-delete-btn">å®Œå…¨ã«å‰Šé™¤</button>
                <button id="cancel-delete-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>
    
    <!-- ãƒ˜ãƒ«ãƒ—/ä½¿ã„æ–¹ãƒ¢ãƒ¼ãƒ€ãƒ«UI -->
    <div id="help-modal">
        <div id="modal-content-help">
            <h3>ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h3>
            <div id="help-list">
                <p>â€¢ <strong>ç©ºãã‚¹ãƒšãƒ¼ã‚¹ã‚¯ãƒªãƒƒã‚¯</strong>: ãƒ¡ãƒ¢ã‚’è¿½åŠ </p>
                <p>â€¢ <strong>ãƒ‰ãƒ©ãƒƒã‚°</strong>: ãƒœãƒ¼ãƒ‰ã®å¹³è¡Œç§»å‹• (ãƒ‘ãƒ³)</p>
                <p>â€¢ <strong>ãƒ›ã‚¤ãƒ¼ãƒ« / ã‚ºãƒ¼ãƒ ãƒœã‚¿ãƒ³</strong>: æ‹¡å¤§ç¸®å° (ã‚ºãƒ¼ãƒ )</p>
                <p>â€¢ <strong>ãƒ¡ãƒ¢ã«ãƒã‚¦ã‚¹ã‚ªãƒ¼ãƒãƒ¼</strong>: å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º</p>
                <p>â€¢ <strong>åº§æ¨™ãƒªã‚»ãƒƒãƒˆ</strong>: ãƒœãƒ¼ãƒ‰ã‚’åˆæœŸä½ç½®ã«æˆ»ã™</p>
                <p>â€¢ <strong>å…¨ãƒ¡ãƒ¢å‰Šé™¤</strong>: ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ï¼ˆè¦ç¢ºèªï¼‰</p>
                <p>â€¢ <strong>ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›</strong>: å…¨ãƒ¡ãƒ¢ã®å†…å®¹ã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</p>
                <p>â€¢ <strong>æ¤œç´¢</strong>: ãƒ¡ãƒ¢ã®å†…å®¹ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤º</p>
            </div>
            <div id="modal-buttons">
                <button id="close-help-btn" class="control-btn" style="background-color: #008855; color: white; border: none;">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>


    <!-- å·¦ä¸Š: ä¸»è¦ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (è‰²é¸æŠ, ã‚¯ãƒªã‚¢, ãƒ˜ãƒ«ãƒ—) -->
    <div id="primary-controls">
        <div class="color-btn active" style="background-color: #fff740;" data-color="#fff740"></div> <!-- Yellow -->
        <div class="color-btn" style="background-color: #ff7eb9;" data-color="#ff7eb9"></div> <!-- Pink -->
        <div class="color-btn" style="background-color: #7afcff;" data-color="#7afcff"></div> <!-- Blue -->
        <div class="color-btn" style="background-color: #feff9c;" data-color="#feff9c"></div> <!-- Pale Yellow -->
        <div class="color-btn" style="background-color: #98ff98;" data-color="#98ff98"></div> <!-- Green -->
        
        <button id="help-btn" class="control-btn">ä½¿ã„æ–¹</button>
        <button id="clear-data-btn" class="control-btn" style="background-color: rgba(170, 0, 0, 0.6);">å…¨ãƒ¡ãƒ¢å‰Šé™¤</button>
    </div>

    <!-- å³ä¸Š: æ¤œç´¢æ©Ÿèƒ½ã®ã¿ -->
    <div id="search-container">
        <input type="text" id="search-input" placeholder="ãƒ¡ãƒ¢ã‚’æ¤œç´¢..." />
        <button id="search-btn" class="control-btn">ğŸ”</button>
    </div>
    
    <!-- å³ä¸‹: ã‚«ãƒ¡ãƒ©æ“ä½œã¨ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
    <div id="utility-controls">
        <div class="util-group">
            <button id="zoom-in-btn" class="control-btn zoom-btn">+</button>
            <button id="zoom-out-btn" class="control-btn zoom-btn">-</button>
        </div>
        
        <div class="util-group" style="margin-top: 5px;">
            <button id="export-txt-btn" class="control-btn" style="background-color: rgba(255, 165, 0, 0.6);">ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›</button>
            <button id="reset-position-btn" class="control-btn" style="background-color: rgba(0, 150, 255, 0.6);">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
    </div>


    <!-- Container for Three.js -->
    <div id="container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { CSS3DRenderer, CSS3DObject } from 'three/addons/renderers/CSS3DRenderer.js';

        let camera, scene, renderer, cssRenderer;
        
        // ãƒ‘ãƒ³æ“ä½œç”¨å¤‰æ•°
        let isPanning = false;
        let panStartX = 0, panStartY = 0;
        
        let raycaster;
        let mouse;
        let clickPlane; // The invisible plane we click on
        
        // State
        let selectedColor = '#fff740';
        let isDragging = false; // ã‚¯ãƒªãƒƒã‚¯ vs ãƒ‰ãƒ©ãƒƒã‚°åˆ¤å®šç”¨
        let mouseDownTime = 0;
        const notes = []; // THREE.CSS3DObjectã®é…åˆ—
        
        // IndexedDB Constants
        const DB_NAME = 'StickyNotesDB';
        const STORE_NAME = 'notes';
        const DB_VERSION = 1;
        
        // ã‚«ãƒ¡ãƒ©ã®åˆæœŸè¨­å®š
        const INITIAL_CAMERA_ZOOM = 1;
        
        // ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–é–¢æ•° (ãƒªã‚µã‚¤ã‚ºã‚¤ãƒ™ãƒ³ãƒˆã§ã‚‚åˆ©ç”¨)
        function setupCamera() {
            const aspectRatio = window.innerWidth / window.innerHeight;
            const size = 1000;
            
            camera = new THREE.OrthographicCamera(
                size * aspectRatio / - 2, 
                size * aspectRatio / 2, 
                size / 2, 
                size / - 2, 
                1, 
                2000
            );
            
            // åˆæœŸä½ç½®ã¨ã‚ºãƒ¼ãƒ 
            camera.position.set(0, 0, 1000);
            camera.zoom = INITIAL_CAMERA_ZOOM;
            camera.updateProjectionMatrix();
        }


        init();
        animate();

        // --- IndexedDB Functions (å¤‰æ›´ãªã—) ---
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };
                request.onerror = (event) => {
                    console.error("IndexedDB error:", event.target.error);
                    reject(event.target.error);
                };
            });
        }

        async function saveNoteToDB(noteData) {
            try {
                const db = await openDB();
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                store.put(noteData);
            } catch (error) {
                console.error("Failed to save note:", error);
            }
        }

        async function deleteNoteFromDB(id) {
            try {
                const db = await openDB();
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                store.delete(id);
            } catch (error) {
                console.error("Failed to delete note:", error);
            }
        }
        
        async function clearAllNotesFromDB() {
            try {
                const db = await openDB();
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                store.clear();
                return true;
            } catch (error) {
                console.error("Failed to clear all notes:", error);
                return false;
            }
        }

        async function loadNotesFromDB() {
            try {
                const db = await openDB();
                const tx = db.transaction(STORE_NAME, 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const request = store.getAll();

                return new Promise((resolve, reject) => {
                    request.onsuccess = () => {
                        resolve(request.result);
                    };
                    request.onerror = (event) => {
                        reject(event.target.error);
                    };
                });

            } catch (error) {
                console.error("Failed to load notes:", error);
                return [];
            }
        }
        // --- End IndexedDB Functions ---


        async function init() {
            const container = document.getElementById('container');

            // 1. Scene Setup
            scene = new THREE.Scene();

            // 2. Camera Setup
            setupCamera();

            // 3. WebGL Renderer (for visual helpers, grid, etc)
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.domElement.style.position = 'absolute';
            renderer.domElement.style.top = 0;
            renderer.domElement.style.zIndex = 1; 
            renderer.domElement.style.pointerEvents = 'none'; 
            container.appendChild(renderer.domElement);

            // 4. CSS3D Renderer (for HTML elements)
            cssRenderer = new CSS3DRenderer();
            cssRenderer.setSize(window.innerWidth, window.innerHeight);
            cssRenderer.domElement.style.position = 'absolute';
            cssRenderer.domElement.style.top = 0;
            cssRenderer.domElement.style.zIndex = 2; 
            container.appendChild(cssRenderer.domElement);

            // 5. Invisible Click Plane & Grid
            const planeGeometry = new THREE.PlaneGeometry(4000, 4000);
            const planeMaterial = new THREE.MeshBasicMaterial({ 
                color: 0x000000, 
                opacity: 0, 
                transparent: true,
                side: THREE.DoubleSide
            });
            clickPlane = new THREE.Mesh(planeGeometry, planeMaterial);
            scene.add(clickPlane);

            // Visual Grid Helper 
            const gridHelper = new THREE.GridHelper(4000, 40, 0x444444, 0x222222);
            gridHelper.rotation.x = Math.PI / 2;
            scene.add(gridHelper);

            // 6. Raycaster setup
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            // 7. Event Listeners
            window.addEventListener('resize', onWindowResize);
            window.addEventListener('wheel', onMouseWheel, { passive: false }); // ã‚ºãƒ¼ãƒ 
            
            // ã‚«ã‚¹ã‚¿ãƒ ãƒ‘ãƒ³æ“ä½œãƒ­ã‚¸ãƒƒã‚¯
            const interactionElement = cssRenderer.domElement;
            
            interactionElement.addEventListener('mousedown', onMouseDown);
            interactionElement.addEventListener('mousemove', onMouseMove);
            interactionElement.addEventListener('mouseup', onMouseUp);
            interactionElement.addEventListener('mouseleave', onMouseUp); 
            
            // 8. UI Controls & Load Notes
            setupUIControls();
            
            const savedNotes = await loadNotesFromDB();
            if (savedNotes.length > 0) {
                savedNotes.forEach(data => {
                    createNote(data.position.x, data.position.y, data.position.z, data.color, data.text, data.rotationZ, data.id);
                });
            } else {
                // Add initial notes if none are saved
                createNote(0, 200, 0, '#fff740', "Welcome!\nHere is your 2D board workspace.", 0.05);
                createNote(-300, 0, 0, '#ff7eb9', "ãƒœãƒ¼ãƒ‰ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ç§»å‹•ã§ãã¾ã™ã€‚", -0.05);
                createNote(300, -100, 0, '#7afcff', "æ¤œç´¢æ©Ÿèƒ½ã§ãƒ¡ãƒ¢ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã§ãã¾ã™ã€‚å³ä¸Šã®å…¥åŠ›æ¬„ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚", 0.1);
            }
        }
        
        // --- ã‚«ãƒ¡ãƒ©æ“ä½œé–¢æ•° ---
        function resetCameraPosition() {
            camera.position.set(0, 0, 1000);
            camera.zoom = INITIAL_CAMERA_ZOOM;
            camera.updateProjectionMatrix();
        }

        function onMouseDown(event) {
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãƒœãƒ¼ãƒ‰æ“ä½œã‚’ç„¡åŠ¹ã«ã™ã‚‹
            if (document.getElementById('confirmation-modal').style.display === 'flex' || 
                document.getElementById('help-modal').style.display === 'flex') {
                return;
            }

            // UIè¦ç´ ä¸Šã§ã®ã‚¯ãƒªãƒƒã‚¯ã§ã¯ãƒ‘ãƒ³ã‚’é–‹å§‹ã—ãªã„
            const targetElement = event.target.closest('.note-element, .control-btn, #primary-controls, #utility-controls, #search-container');
            if (targetElement) return;

            isPanning = true;
            panStartX = event.clientX;
            panStartY = event.clientY;
            isDragging = false;
            mouseDownTime = Date.now();
            document.body.style.cursor = 'grabbing';
        }

        function onMouseMove(event) {
            if (Date.now() - mouseDownTime > 50 || Math.abs(event.clientX - panStartX) > 5 || Math.abs(event.clientY - panStartY) > 5) {
                isDragging = true;
            }

            if (isPanning) {
                const deltaX = event.clientX - panStartX;
                const deltaY = event.clientY - panStartY;

                const cameraWidth = camera.right - camera.left;
                const cameraHeight = camera.top - camera.bottom;
                
                const moveFactorX = cameraWidth / window.innerWidth / camera.zoom;
                const moveFactorY = cameraHeight / window.innerHeight / camera.zoom;

                camera.position.x -= deltaX * moveFactorX;
                camera.position.y += deltaY * moveFactorY;
                
                camera.updateProjectionMatrix();

                panStartX = event.clientX;
                panStartY = event.clientY;
            }
        }

        function onMouseUp(event) {
            document.body.style.cursor = 'grab';
            
            if (isPanning && !isDragging) {
                onMouseClick(event);
            }

            isPanning = false;
            isDragging = false;
        }

        // --- ã‚ºãƒ¼ãƒ æ“ä½œé–¢æ•° ---
        function onMouseWheel(event) {
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãƒœãƒ¼ãƒ‰æ“ä½œã‚’ç„¡åŠ¹ã«ã™ã‚‹
            if (document.getElementById('confirmation-modal').style.display === 'flex' || 
                document.getElementById('help-modal').style.display === 'flex') {
                return;
            }
            
            event.preventDefault(); 
            zoomCamera(event.deltaY > 0 ? 1.1 : 0.9);
        }

        function zoomCamera(scaleFactor) {
            const currentZoom = camera.zoom;
            let newZoom = currentZoom / scaleFactor;
            
            // ã‚ºãƒ¼ãƒ åˆ¶é™ (æœ€å°0.1ã€æœ€å¤§5)
            newZoom = Math.max(0.1, Math.min(5, newZoom));
            
            if (newZoom !== currentZoom) {
                camera.zoom = newZoom;
                camera.updateProjectionMatrix();
            }
        }
        
        // --- æ¤œç´¢æ©Ÿèƒ½ ---
        function searchNotes() {
            const query = document.getElementById('search-input').value.trim().toLowerCase();
            
            // å…¨ã¦ã®ãƒ¡ãƒ¢ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
            notes.forEach(object => {
                object.element.classList.remove('highlighted');
            });

            if (query === '') return;

            // æ¤œç´¢ã¨ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            notes.forEach(object => {
                const textarea = object.element.querySelector('.note-textarea');
                const text = textarea ? textarea.value.toLowerCase() : '';
                
                if (text.includes(query)) {
                    object.element.classList.add('highlighted');
                }
            });
        }


        // --- UI & Modal Controls ---
        function setupUIControls() {
            // --- å·¦ä¸Š: primary-controls ---
            const colorBtns = document.querySelectorAll('.color-btn');
            colorBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    colorBtns.forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    selectedColor = e.target.dataset.color;
                    e.stopPropagation();
                });
            });
            
            // ãƒ˜ãƒ«ãƒ—ãƒœã‚¿ãƒ³ (ä½¿ã„æ–¹) ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            const helpBtn = document.getElementById('help-btn');
            const helpModal = document.getElementById('help-modal');
            const closeHelpBtn = document.getElementById('close-help-btn');
            
            helpBtn.addEventListener('click', (e) => {
                helpModal.style.display = 'flex';
                e.stopPropagation();
            });

            closeHelpBtn.addEventListener('click', () => {
                helpModal.style.display = 'none';
            });
            
            // å…¨ãƒ¡ãƒ¢å‰Šé™¤ãƒœã‚¿ãƒ³ (ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º)
            document.getElementById('clear-data-btn').addEventListener('click', (e) => {
                document.getElementById('confirmation-modal').style.display = 'flex';
                e.stopPropagation();
            });
            
            // --- å³ä¸Š: search-container ---
            document.getElementById('search-btn').addEventListener('click', (e) => {
                searchNotes();
                e.stopPropagation();
            });
            
            document.getElementById('search-input').addEventListener('input', (e) => {
                if (e.target.value.trim() === '') {
                    // å…¥åŠ›ãŒç©ºã«ãªã£ãŸã‚‰ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
                    notes.forEach(object => object.element.classList.remove('highlighted'));
                }
            });
            
            document.getElementById('search-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchNotes();
                    e.stopPropagation();
                }
            });

            // --- å³ä¸‹: utility-controls ---
            // åº§æ¨™ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
            document.getElementById('reset-position-btn').addEventListener('click', (e) => {
                resetCameraPosition();
                e.stopPropagation();
            });
            
            // ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›ãƒœã‚¿ãƒ³
            document.getElementById('export-txt-btn').addEventListener('click', (e) => {
                exportNotesAsTxt();
                e.stopPropagation();
            });
            
            // ã‚ºãƒ¼ãƒ ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
            const zoomInBtn = document.getElementById('zoom-in-btn');
            const zoomOutBtn = document.getElementById('zoom-out-btn');
            
            zoomInBtn.addEventListener('click', (e) => {
                zoomCamera(0.8); 
                e.stopPropagation();
            });
            zoomOutBtn.addEventListener('click', (e) => {
                zoomCamera(1.25); 
                e.stopPropagation();
            });


            // --- ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€šå‡¦ç† ---
            // ãƒ¢ãƒ¼ãƒ€ãƒ«: å‰Šé™¤å®Ÿè¡Œãƒœã‚¿ãƒ³
            document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
                const success = await clearAllNotes();
                if (success) {
                    document.getElementById('confirmation-modal').style.display = 'none';
                    resetCameraPosition();
                }
            });

            // ãƒ¢ãƒ¼ãƒ€ãƒ«: ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
            document.getElementById('cancel-delete-btn').addEventListener('click', () => {
                document.getElementById('confirmation-modal').style.display = 'none';
            });
        }
        
        // --- ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›é–¢æ•° (åº§æ¨™ãƒ»è‰²æƒ…å ±å‰Šé™¤) ---
        function exportNotesAsTxt() {
            if (notes.length === 0) {
                console.log("No notes to export.");
                return;
            }

            const exportedText = notes.map((object, index) => {
                const data = getNoteData(object);
                
                // æ•´å½¢ã•ã‚ŒãŸå‡ºåŠ›æ–‡å­—åˆ— (å†…å®¹ã®ã¿)
                return `--- MEMO ${index + 1} ---\n` + 
                       `${data.text.trim()}\n` +
                       `--------------------------\n`;
            }).join('\n'); // ã™ã¹ã¦ã®ãƒ¡ãƒ¢ã‚’2è¡Œã®æ”¹è¡Œã§çµåˆ

            // Blobã‚’ä½œæˆã—ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
            const blob = new Blob([exportedText], { type: 'text/plain;charset=utf-8' });
            const today = new Date().toISOString().slice(0, 10);
            const fileName = `sticky_notes_export_${today}.txt`;
            
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = fileName;
            
            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            console.log(`Exported ${notes.length} notes to ${fileName}`);
        }
        
        async function clearAllNotes() {
            const success = await clearAllNotesFromDB();
            if (success) {
                notes.forEach(noteObject => {
                    scene.remove(noteObject);
                    if (noteObject.element && noteObject.element.parentNode) {
                        noteObject.element.parentNode.removeChild(noteObject.element);
                    }
                });
                notes.length = 0; 
                console.log("All notes cleared from scene and IndexedDB.");
                return true;
            }
            return false;
        }


        function onMouseClick(event) {
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãƒ¡ãƒ¢è¿½åŠ ã‚’ç„¡åŠ¹ã«ã™ã‚‹
            if (document.getElementById('confirmation-modal').style.display === 'flex' || 
                document.getElementById('help-modal').style.display === 'flex') {
                return;
            }
            
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);

            const intersects = raycaster.intersectObject(clickPlane);

            if (intersects.length > 0) {
                const point = intersects[0].point;
                const rotationZ = (Math.random() - 0.5) * 0.1; 
                createNote(point.x, point.y, 0, selectedColor, '', rotationZ);
            }
        }

        function createNote(x, y, z, color, initialText = '', rotationZ = 0, id = null) {
            const noteId = id || crypto.randomUUID();

            const div = document.createElement('div');
            div.className = 'note-element';
            div.style.backgroundColor = color;
            div.dataset.noteId = noteId; 

            const textarea = document.createElement('textarea');
            textarea.className = 'note-textarea';
            textarea.placeholder = "Type here...";
            textarea.value = initialText;
            
            // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ä¸Šã§ã®æ“ä½œã¯ãƒœãƒ¼ãƒ‰ç§»å‹•ã‚’é˜²ã
            textarea.addEventListener('mousedown', (e) => {
                e.stopPropagation(); 
                isPanning = false; 
            });
            textarea.addEventListener('touchstart', (e) => e.stopPropagation());

            // Save data on change
            const debouncedSave = debounce(() => {
                saveNoteToDB(getNoteData(object));
            }, 500); // 500msã®ãƒ‡ã‚£ãƒ¬ã‚¤ã§ä¿å­˜

            textarea.addEventListener('input', debouncedSave);
            textarea.addEventListener('blur', debouncedSave);

            // å‰Šé™¤ãƒœã‚¿ãƒ³ã®è¿½åŠ 
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Ã—';
            deleteBtn.className = 'delete-btn';

            deleteBtn.addEventListener('mousedown', function(e) {
                e.stopPropagation(); 
                isPanning = false; 
            });

            // ãƒ¡ãƒ¢ã”ã¨ã®å‰Šé™¤ãƒœã‚¿ãƒ³ (ç¢ºèªãªã—ã§å³åº§ã«å‰Šé™¤)
            deleteBtn.addEventListener('click', function(e) {
                e.stopPropagation(); 
                deleteNote(object, noteId);
            });


            div.appendChild(textarea);
            div.appendChild(deleteBtn); 

            const object = new CSS3DObject(div);
            object.position.set(x, y, z);
            object.rotation.z = rotationZ;
            
            object.position.z = 0; 

            object.userData = { 
                id: noteId,
                color: color,
                rotationZ: rotationZ
            };

            scene.add(object);
            notes.push(object);
            
            if (!id) {
                 saveNoteToDB(getNoteData(object));
            }
            
            return object;
        }
        
        // å…¥åŠ›æ™‚ã®DBæ›¸ãè¾¼ã¿é »åº¦ã‚’æ¸›ã‚‰ã™ãŸã‚ã®ãƒ‡ãƒã‚¦ãƒ³ã‚¹é–¢æ•°
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }
        
        function getNoteData(object) {
            const textarea = object.element.querySelector('.note-textarea');
            return {
                id: object.userData.id,
                text: textarea ? textarea.value : '',
                color: object.userData.color,
                rotationZ: object.userData.rotationZ,
                position: { 
                    x: object.position.x, 
                    y: object.position.y, 
                    z: object.position.z 
                }
            };
        }


        function deleteNote(object, id) {
            scene.remove(object);
            
            if (object.element && object.element.parentNode) {
                object.element.parentNode.removeChild(object.element);
            }

            const index = notes.indexOf(object);
            if (index > -1) {
                notes.splice(index, 1);
            }
            
            deleteNoteFromDB(id);
        }

        function onWindowResize() {
            // ã‚«ãƒ¡ãƒ©ã‚’å†ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
            setupCamera(); 

            renderer.setSize(window.innerWidth, window.innerHeight);
            cssRenderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
            cssRenderer.render(scene, camera);
        }

    </script>
</body>
</html>